# VCM Backend - Dockerfile para Sistema Python
# Inclui todos os scripts de automação, APIs e processamento

FROM python:3.11-slim

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV DEBIAN_FRONTEND=noninteractive

# Set work directory
WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    git \
    libpq-dev \
    libffi-dev \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements first (for Docker layer caching)
COPY requirements.txt requirements-api.txt ./

# Install Python dependencies
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt && \
    pip install --no-cache-dir -r requirements-api.txt

# Install essential VCM dependencies
RUN pip install --no-cache-dir \
    fastapi \
    uvicorn[standard] \
    supabase \
    openai \
    anthropic \
    google-generativeai \
    python-multipart \
    jinja2 \
    aiofiles \
    python-dotenv \
    psycopg2-binary \
    sqlalchemy \
    alembic \
    requests \
    pydantic

# Copy application files
COPY . .

# Remove problematic files that may not exist in all environments
RUN rm -f start-system.js vcm-backend-server.js || true

# Accept build arguments for environment variables
ARG VCM_SUPABASE_URL
ARG VCM_SUPABASE_ANON_KEY
ARG VCM_SUPABASE_SERVICE_ROLE_KEY
ARG OPENAI_API_KEY
ARG GOOGLE_AI_API_KEY
ARG LIFEWAY_SUPABASE_URL
ARG LIFEWAY_SUPABASE_SERVICE_KEY

# Set environment variables
ENV VCM_SUPABASE_URL=$VCM_SUPABASE_URL
ENV VCM_SUPABASE_ANON_KEY=$VCM_SUPABASE_ANON_KEY
ENV VCM_SUPABASE_SERVICE_ROLE_KEY=$VCM_SUPABASE_SERVICE_ROLE_KEY
ENV OPENAI_API_KEY=$OPENAI_API_KEY
ENV GOOGLE_AI_API_KEY=$GOOGLE_AI_API_KEY
ENV LIFEWAY_SUPABASE_URL=$LIFEWAY_SUPABASE_URL
ENV LIFEWAY_SUPABASE_SERVICE_KEY=$LIFEWAY_SUPABASE_SERVICE_KEY

# Create necessary directories
RUN mkdir -p /app/logs /app/output /app/temp

# Set permissions for scripts
RUN find /app -name "*.py" -exec chmod +x {} \; || true
RUN find /app -name "*.sh" -exec chmod +x {} \; || true

# Create a non-root user
RUN useradd --create-home --shell /bin/bash vcm
RUN chown -R vcm:vcm /app
USER vcm

# Expose API port (but let Easypanel control actual port)
EXPOSE 8000

# Health check with dynamic port
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:${PORT:-8000}/health || exit 1

# Start with dynamic port support
CMD ["sh", "-c", "echo 'Starting VCM Backend API on port '${PORT:-8000}'...' && python -m uvicorn api_bridge:app --host 0.0.0.0 --port ${PORT:-8000}"]